<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí –ú–∞–≥–∞–∑–∏–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .points {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }

        .card-container {
            position: relative;
            margin-bottom: 20px;
        }

        .card {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-image {
            width: 100%;
            max-width: 300px;
            height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: block;
            background: var(--tg-theme-bg-color, #ffffff);
        }

        .card-info {
            text-align: center;
        }

        .card-name {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }

        .card-rating {
            font-size: 20px;
            color: #ff9800;
            margin-bottom: 10px;
        }

        .card-details {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .rarity-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .rarity-common {
            background: #9e9e9e;
            color: white;
        }

        .rarity-rare {
            background: #2196f3;
            color: white;
        }

        .rarity-unique {
            background: #9c27b0;
            color: white;
        }

        .rarity-legendary {
            background: #ff9800;
            color: white;
        }

        .card-price {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
            margin: 15px 0;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .nav-button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
            font-weight: bold;
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-button:not(:disabled):active {
            opacity: 0.8;
        }

        .card-counter {
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
            font-weight: bold;
        }

        .buy-button {
            width: 100%;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 10px;
        }

        .buy-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .buy-button:not(:disabled):active {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #f44336;
            font-size: 16px;
        }

        .empty {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí –ú–∞–≥–∞–∑–∏–Ω</h1>
            <div class="points" id="points">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div id="content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let shopItems = [];
        let currentIndex = 0;
        let userPoints = 0;

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ initData
        function getInitData() {
            try {
                const initData = tg.initData;
                if (!initData) return null;
                
                // –ü–∞—Ä—Å–∏–º initData (—ç—Ç–æ URL-encoded —Å—Ç—Ä–æ–∫–∞)
                const params = new URLSearchParams(initData);
                const userStr = params.get('user');
                if (userStr) {
                    return JSON.parse(decodeURIComponent(userStr));
                }
            } catch (e) {
                console.error('Error parsing initData:', e);
            }
            return null;
        }

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å
        async function loadShopData() {
            try {
                const startParam = tg.initDataUnsafe?.start_param;
                if (startParam) {
                    // –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞–Ω—ã —á–µ—Ä–µ–∑ start_param (–∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã –≤ base64)
                    const data = JSON.parse(atob(startParam));
                    shopItems = data.items || [];
                    userPoints = data.points || 0;
                } else {
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å –∫ –±–æ—Ç—É
                    const user = tg.initDataUnsafe?.user;
                    if (user) {
                        // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –±–æ—Ç—É —á–µ—Ä–µ–∑ Telegram Bot API
                        // –ù–æ –ø—Ä–æ—â–µ –ø–µ—Ä–µ–¥–∞—Ç—å —á–µ—Ä–µ–∑ start_param
                        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                        return;
                    }
                }

                if (shopItems.length === 0) {
                    showEmpty();
                } else {
                    renderCard();
                    updatePoints();
                }
            } catch (e) {
                console.error('Error loading shop data:', e);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function updatePoints() {
            const pointsEl = document.getElementById('points');
            pointsEl.textContent = `üí∞ Footpoints: ${userPoints}`;
        }

        function renderCard() {
            if (currentIndex < 0 || currentIndex >= shopItems.length) {
                return;
            }

            const item = shopItems[currentIndex];
            const contentEl = document.getElementById('content');

            const rarityClass = `rarity-${item.rarity || 'common'}`;
            const rarityNames = {
                'common': '–û–±—ã—á–Ω–∞—è',
                'rare': '–†–µ–¥–∫–∞—è',
                'unique': '–£–Ω–∏–∫–∞–ª—å–Ω–∞—è',
                'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è'
            };
            const rarityText = rarityNames[item.rarity] || item.rarity;

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
            let imageSrc = '';
            if (item.image_url) {
                if (item.image_url.startsWith('http')) {
                    imageSrc = item.image_url;
                } else {
                    // –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞ –∫–∞–∫ –ø—Ä–æ–∫—Å–∏
                    // –ò–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π URL
                    imageSrc = item.image_url;
                }
            }

            const details = [];
            if (item.position) details.push(`–ü–æ–∑–∏—Ü–∏—è: ${item.position}`);
            if (item.club) details.push(`–ö–ª—É–±: ${item.club}`);
            if (item.country) details.push(`–°—Ç—Ä–∞–Ω–∞: ${item.country}`);

            const canBuy = userPoints >= item.price;

            contentEl.innerHTML = `
                <div class="card-container">
                    <div class="navigation">
                        <button class="nav-button" ${currentIndex === 0 ? 'disabled' : ''} onclick="previousCard()">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                        <div class="card-counter">${currentIndex + 1} / ${shopItems.length}</div>
                        <button class="nav-button" ${currentIndex >= shopItems.length - 1 ? 'disabled' : ''} onclick="nextCard()">
                            –í–ø–µ—Ä–µ–¥ ‚Üí
                        </button>
                    </div>

                    <div class="card">
                        ${imageSrc ? `<img src="${imageSrc}" alt="${item.player_name}" class="card-image" onerror="this.style.display='none'">` : ''}
                        <div class="card-info">
                            <div class="card-name">${item.player_name}</div>
                            <div class="card-rating">‚≠ê ${item.rating}</div>
                            <div class="rarity-badge ${rarityClass}">${rarityText}</div>
                            ${details.length > 0 ? `<div class="card-details">${details.join('<br>')}</div>` : ''}
                            <div class="card-price">üí∞ ${item.price} footpoints</div>
                            <button class="buy-button" ${!canBuy ? 'disabled' : ''} onclick="buyItem(${item.shop_item_id})">
                                ${canBuy ? '–ö—É–ø–∏—Ç—å' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function previousCard() {
            if (currentIndex > 0) {
                currentIndex--;
                renderCard();
            }
        }

        function nextCard() {
            if (currentIndex < shopItems.length - 1) {
                currentIndex++;
                renderCard();
            }
        }

        function buyItem(shopItemId) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–Ω—ã
            const item = shopItems[currentIndex];
            if (item.price > userPoints) {
                tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ footpoints –¥–ª—è –ø–æ–∫—É–ø–∫–∏!');
                return;
            }

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ${item.player_name} –∑–∞ ${item.price} footpoints?`)) {
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç–∞
            tg.sendData(JSON.stringify({
                action: 'buy_shop_item',
                shop_item_id: shopItemId
            }));
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º MiniApp –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            tg.close();
        }

        function showEmpty() {
            const contentEl = document.getElementById('content');
            contentEl.innerHTML = `
                <div class="empty">
                    üõí –ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç<br>
                    –í—Å–µ —Ç–æ–≤–∞—Ä—ã —É–∂–µ –∫—É–ø–ª–µ–Ω—ã
                </div>
            `;
        }

        function showError(message) {
            const contentEl = document.getElementById('content');
            contentEl.innerHTML = `
                <div class="error">
                    ‚ùå ${message}
                </div>
            `;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
        tg.onEvent('viewportChanged', function() {
            tg.expand();
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadShopData();
    </script>
</body>
</html>

